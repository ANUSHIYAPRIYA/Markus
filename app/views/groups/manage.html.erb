<%= stylesheet_link_tag("livepipe/tabs") %>
<%= javascript_include_tag "livepipe/livepipe.js" %>
<%= javascript_include_tag "livepipe/window.js" %>
<%= javascript_include_tag "livepipe/tabs.js" %>
<%= javascript_include_tag "16accordion.js" %>
<%= javascript_include_tag "manage_groups.js" %>
<%= javascript_include_tag "FilterTable/FilterTable.js" %>

<%= render :partial => "boot.js.erb" %>
<script>

var modalCreate = null;
var modalAssignmentGroupReUse = null;
var modalRenameGroup = null;
var modalAddMember = null;

function make_new_group() {
   if(<%= @assignment.group_name_autogenerated == false%>)
   {
      modalCreate.open();
      $('new_group_name').setValue('');
      return false;
   } else {
     <%= remote_function(
       :url  => { :action => 'add_group', :id => @assignment.id})
     %>
   }
}

function submit_new_group(new_group_name) {

  //close the dialog
  modalCreate.close();
  //send AJAX request
  <%= 
 remote_function(
    :url  => { :action => 'add_group', :id => @assignment.id},
    :with => "'&new_group_name=' + new_group_name")
  %>
}

function rename_group(id) {
      modalRenameGroup.open();
      $grouping_id = id;
      $('new_groupname').setValue('');
      return false;
}

function submit_add_member(new_member, grouping_id){
  modalAddMember.close();
  <%=
    remote_function(
      :url => { :action => 'add_member', :id => @assignment.id},
      :with => "'&grouping_id=' + grouping_id + '&student_user_name=' + new_member"
    )
  %>
}

function submit_rename_group(new_groupname, grouping_id) {
  //close the dialog
  modalRenameGroup.close();
  //send AJAX request
  <%= 
 remote_function(
    :url  => { :action => 'rename_group', :id => @assignment.id},
    :with => "'&grouping_id=' + grouping_id +  '&new_groupname=' + new_groupname")
  %>
}

function assignment_group_use() {
    modalAssignmentGroupReUse.open();
    $('clone_groups_assignment_id').setValue('');
    return false;
 }

function add_member(id) {
    if(accordion.current != $$('.accordion-content')[0]){
      accordion.toExpand = $$('.accordion-content')[0];
      accordion.toExpand.show();
      accordion.animate();
    }
    modalAddMember.open();
    $grouping_id = id
    $('new_student').setValue('');
    return false;
 }

function submit_assignment_group_use(clone_groups_assignment_id) {

  //close the dialog
  modalAssignmentGroupReUse.close();
  //send AJAX request
  <%= 
 remote_function(
    :url  => { :action => 'use_another_assignment_groups', :id => @assignment.id},
    :with => "'&clone_groups_assignment_id=' + clone_groups_assignment_id")
  %>

}

document.observe("dom:loaded", function(){
    //Create the modal dialog
  modalCreate = new Control.Modal($('create_group_dialog'), 
  {
    overlayOpacity: 0.75,
    className: 'modalCreate',
    fade:false
 
  });

  modalRenameGroup = new Control.Modal($('rename_group_dialog'), 
  {
    overlayOpacity: 0.75,
    className: 'modalRenameGroup',
    fade:false
 
  });

  modalAddMember = new Control.Modal($('add_member_dialog'), 
  {
    overlayOpacity: 0.75,
    className: 'modalAddMember',
    fade:false
 
  });

 modalAssignmentGroupReUse = new Control.Modal($('assignment_group_use_dialog'), 
  {
    overlayOpacity: 0.75,
    className: 'modalAssignmentGroupReUse',
    fade:false
  });
})




</script>

<script type="text/javascript" language="JavaScript">
  function clearText(id) {
    $("student_user_name").value = "";
  }
  function focusText(id) {
    $("student_user_name").focus();
  }
</script>

<% if @assignment.past_due_date? %>
<div class="notice">
  <%=t('groups.editing_past_due_date_warning')%>
</div>
<% end %>

<div id="title_bar">
  <h1>Manage Groups
  <%= button_to_function "Use another assignment's groups", 'assignment_group_use(); return
    false;' %> 
   <span class="menu_bar">|</span> 
    <% if @assignment.group_name_autogenerated %>
      <%= button_to_remote "Add New", :url => {:action => 'add_group', :id => @assignment.id}, :before => "$('loading_list').show();groupings_table.clear_filters().render();", :complete => "$('loading_list').hide();"  %>  
    <% else %>
      <%= button_to_function "Add New", "make_new_group();", :before => "$('loading_list').show();groupings_table.clear_filters().render();", :complete => "$('loading_list').hide();"  %>  
    <% end %>
   </h1>
  </div> <!-- title_bar-->
<div class="wrapLeft">
      <div id="toggle_actions">
       <%= I18n.t(:filters) %>:
       <%= link_to_function I18n.t(:all) + " (<span
id=\"all_groupings_count\"></span>)", "filter('none')", :id =>
"filter_link_none", :class => "filter_selected" %>
	|
        <%= link_to_function "Valid (<span id=\"valid_groupings_count\"></span>)", "filter('validated')", :id => "filter_link_validated" %>

	|
        <%= link_to_function "Not valid (<span id=\"invalid_groupings_count\"></span>)", "filter('unvalidated')", :id => "filter_link_unvalidated"%>
	|
        <%= link_to_function "Assigned (<span id=\"assigned_groupings_count\"></span>)", "filter('assigned')", :id => "filter_link_assigned"%>
	|
        <%= link_to_function "Not assigned (<span id=\"unassigned_groupings_count\"></span>)", "filter('unassigned')", :id => "filter_link_unassigned" %>
      </div>
</div>
<div class="clear"></div>

    <div id="notice">
      <% # This is for error display injected by JavaScript 
       %>
      
      <div class="error" id="errors" style="display: none; ">
        <h3>There was a problem...</h3>
        <div id="errors_title">
        </div>
        <div id="errors_contents">
        </div>
      </div>
      
      <% # if there are errors have the error message display %>
      <% if flash[:error] || flash[:fail_notice] || flash[:invalid_lines] %>
        <div class="error">
          <%= h(flash[:error])+"<br/>" if flash[:error] %>
          <%= h(flash[:fail_notice])+"<br/>" if flash[:fail_notice] %>
          <% if flash[:invalid_lines] %>
            The following lines could not be processed:
            <ul>
            <% flash[:invalid_lines].each do |error| %>
              <li><%=error%></li>
            <% end %>
            </ul>
          <% end %>
        </div>
      <% end %>
      
      <% # if there are success messages to display
				%>
      <% if flash[:upload_notice] || flash[:edit_notice] -%>
        <div class="success">
          <%= h(flash[:upload_notice])+"<br/>" if flash[:upload_notice] %>
          <%= h(flash[:edit_notice])+"<br/>" if flash[:edit_notice] %>
        </div>
      <% end %>
      
    </div><!-- Notice -->

    <%= form_remote_tag :url => {:controller => "groups", :action => "global_actions", :id => @assignment.id}, :html => {:id => "global_action_form"}, :loading => "thinking();", :complete => "done_thinking();"%>
<div class="clear"></div>
<div class="colsLeftHeavy">
  <div class="colLeft">
    <div class="wrapLeft">
      <div class="global_action_top">
        <span id="loading_list"><%= image_tag("spinner.gif") %> Loading List...</span>
        <%= select_tag "global_actions", options_for_select([["Choose an action", ""], ["Validate", "valid"], ["Invalidate", "invalid"], ["Delete", "delete"], ["Assign Grader(s)", "assign"], ["Unassign Grader(s)", "unassign"]]), :onchange => "$('global_actions_2').setValue($(this).getValue());"%>
	<%= submit_tag I18n.t(:apply), :onclick => "$('submit_type').setValue('global_action');" %>
        <%= hidden_field_tag 'submit_type', 'global_action', :id => 'submit_type' %>
      </div>

      <div class="clear"></div>
      <div id="groups_container">
        <table class="groups" id="groups">
        </table>
      </div><!-- group container -->
      
      <div class="global_action_bottom">
        <%= select_tag "global_actions_2", options_for_select([["Choose an action", ""], ["Validate", "valid"], ["Invalidate", "invalid"], ["Delete", "delete"], ["Assign Grader(s)", "assign"], ["Unassign Grader(s)", "unassign"]]), :onClick => "$('global_actions').setValue($(this).getValue());"%>
	<%= submit_tag I18n.t(:apply), :onchange => "$('submit_type').setValue('global_action');" %>
      </div>
    </div>
    
  </div> <!-- colLeft -->
  <div class="colRight">
    <% # order of processing students is important. we go through each member 
       # one by one and delete them above from the list of students 
       # if they are already in a group
       # See manage/_group.html.erb
    %>
    <div id="test-accordion" class="accordion">
      <div id="accordion-toggle-top" class="accordion-toggle">
        Students without a group (<span id="number_of_ungrouped_students"><%= @ungrouped_students.length%></span>)
      </div>
      <div class="accordion-content">
        <p>
        <% if @ungrouped_students.length != 0 %>
          <%= I18n.t(:students_without_a_group_list_message)%>
        <% else %>
          <%= I18n.t(:no_students_without_a_group_message)%>
        <% end %>
        </p>
        <ul id="student_list">
        <% @ungrouped_students.each do |s| -%>
          <li><%= h(s.user_name) %></li>
        <% end -%>
        </ul>
      </div>
      <div class="accordion-toggle">
        Graders (<%= @tas.length %>)
      </div>
      <div class="accordion-content">

       <%= submit_tag "Randomly assign Graders", :id => "random_assign_graders", :name => "random_assign_graders", :confirm => "Are you sure you want to randomly assign selected graders to all groups?", :onclick => "$('submit_type').setValue('random_assign');" %>
       
       <%= render :partial => 'grader_list', :locals => {:tas => @tas} %>

      </div>
      </form>
      <div class="accordion-toggle" id="accordion-toggle-bottom">
        Upload/Download
      </div>
      <div class="accordion-content">
        <div id="upload">
          <p>
            <h3>Upload Groups File</h3>
            CSV file format:<br />
            <code>group_name,repository_name,user_name,<br />user_name ... </code><br />
            <% if !@groupings.nil? && @groupings.length > 0 %>
              <br/>
              <div class="information">
                Importing groups via CSV upload into <%= t(:markus) %> will destroy existing groups!
              </div>
            <% end %>
          </p>
          <% form_for :group, :html => {:multipart => true},
                             :url => { :controller=>"groups",
                                       :action => 'csv_upload',
                                       :id => @assignment.id } do |f| -%>
           <p><%= f.file_field :grouplist, :size => 2 %> <br />
              <%= submit_tag t(:upload), :disable_with => t(:uploading_please_wait) %></p>							
        <% end %>
        </div> <!-- Upload -->
        <p id="download">
          <%= link_to 'Download group list CSV Format', {:controller=>"groups", :action=>"download_grouplist", :id=> @assignment.id}%>
        </p>
        <p>
          <h3>Upload Group / Grader Map</h3>
            CSV file format:<br />
            <code>group_name,grader_user_name,grader_user_name,... </code><br />
          </p>
          <% form_tag({:controller=>"groups", :action => 'csv_upload_grader_mapping',:id => @assignment.id}, {:multipart => true}) do -%>
           <p><%= file_field_tag :grader_mapping, :size => 2 %> <br />
              <%= submit_tag t(:upload), :disable_with => t(:uploading_please_wait) %></p>							
        <% end %>
          
        </p>
      </div>
     </div>
   </div>
    <!-- remote form tag -->
  </div> <!-- colRight -->
</div> <!-- ColsLeftHeavy -->


<!-- Modal Windows -->

<div id="add_member_dialog">
      <h2>Add A Member</h2>
    <p>
      <fieldset>
	 Student: <input type="text" id="new_student"></input>
      </fieldset>
      <p class="p_margin">
        <button onClick="submit_add_member(escape($F('new_student')),
($grouping_id));">Add student</button>
        <button onClick="modalAddMember.close();">Cancel</button>
      </p> 

</div> 

<div id="rename_group_dialog">
      <h2>Rename group</h2>
    <p>
      <fieldset>
      Group Name
      <input type="text" id="new_groupname"></input>
      </fieldset>
    </p>
    <p class="p_margin">
        <button
	onClick="submit_rename_group(escape($F('new_groupname')),
($grouping_id));">Rename group</button>
        <button onClick="modalRenameGroup.close();">Cancel</button>
      </p> 
</div>
<div id="assignment_group_use_dialog">
      <h2>Reuse Groups</h2>
    <p>
      <fieldset>
      <p>Which assignments groups would you like to use?</p>
      <select id="clone_groups_assignment_id" name="clone_groups_assignment_id">
        <% @all_assignments.each do |an_assignment| %>
          <% if an_assignment != @assignment %>
          <option value="<%=h(an_assignment.id)%>"><%=h(an_assignment.short_identifier)%></option>
          <% end %>
        <% end %>
      </select>
      </fieldset>
    </p>
    <p class="p_modal">
   <%= button_to_function 'Submit',
       "if (confirm('This will delete all the groups linked to this assignment. Continue?' )) submit_assignment_group_use(escape($F('clone_groups_assignment_id')))"
   %>        
   <%= button_to_function "cancel", 'modalAssignmentGroupReUse.close()'%>
    </p>    
  </div> <!-- Assignement reuse groups modal-->
 
  <div id="create_group_dialog">
      <h2>Create new group</h2>
    <p>
      <fieldset>
      Group Name
      <input type="text" id="new_group_name"></input>
      </fieldset>
    </p>
    <p class="p_modal">
    <%= button_to_function "Create new group",
"submit_new_group(escape($F('new_group_name')));" %>       
    <%= button_to_function "Cancel", 'modalCreate.close()'%> 
       </p>
      
  </div>
 
 
